# Plan 29: Enforce CollectionId Type Safety

## Overview

Replace raw `string` usage for collection IDs with the `CollectionId` domain type across all layers. This fixes a startup crash caused by `MonitorEnvironmentOperations.getDefaultCollectionId()` generating non-UUID strings (`preset-N-monitor`) that fail `CollectionId` validation.

## Problem

### Crash

On startup, `syncActiveCollectionToHistory()` in `controller.ts:231` creates `new CollectionId(collectionIdStr)` from a value stored in GSettings. When this value is `preset-2-monitor` (a non-UUID format generated by `getDefaultCollectionId()`), the constructor throws `InvalidCollectionIdError`, preventing the extension from loading.

### Root Cause

The operations layer passes collection IDs as raw `string`, bypassing `CollectionId` type validation. This allows invalid values (like `preset-2-monitor`) to flow through the system undetected until they reach a point where `CollectionId` is finally constructed.

If `CollectionId` were used consistently, `getDefaultCollectionId()` would be forced to produce a valid `CollectionId` at compile time, making this class of bug impossible.

## Scope

All layers: domain types, operations, infrastructure, composition/controller, UI/MainPanel, prefs.

## Changes

### Domain Layer

#### `src/domain/layout/types.ts`

- Change `SpaceCollection.id` from `string` to `CollectionId`

#### `src/domain/monitor/types.ts`

- Change `MonitorEnvironment.lastActiveCollectionId` from `string` to `CollectionId | null`
  - `null` represents "no collection has been explicitly activated" (replaces empty string `''`)

### Operations Layer

#### `src/operations/monitor/monitor-environment-operations.ts`

- Change `currentActiveCollectionId` field from `string` to `CollectionId | null`
- Change `detectAndSaveMonitors()` return type from `string | null` to `CollectionId | null`
- Change `setActiveCollectionId()` parameter from `string` to `CollectionId`
- Change `getLastActiveCollectionId()` return type from `string | null` to `CollectionId | null`
- Remove `getDefaultCollectionId()` method
  - New environments get `lastActiveCollectionId: null` instead of `preset-N-monitor`
  - `null` flows through to `getActiveSpaceCollection(null)` which already falls back to the first preset

#### `src/operations/layout/space-collection-operations/index.ts`

- Change `findCollectionById()` parameter from `string` to `CollectionId`
- Change `deleteCustomCollection()` parameter from `string` to `CollectionId`
- Change `updateSpaceEnabled()` `collectionId` parameter from `string` to `CollectionId`
- Change `getActiveSpaceCollection()` parameter from `string` to `CollectionId | null`
  - `null` triggers fallback to first preset (existing behavior for empty string)
- Change `resolveActiveSpaceCollectionId()` return type from `string` to `CollectionId | null`
- Remove internal `new CollectionId(collectionId)` conversions — callers now provide the typed value

#### `src/operations/layout/space-collection-repository.ts`

- Update `findCollectionById()` parameter from `CollectionId` (already correct)
- Update `deleteCustomCollection()` parameter to `CollectionId`

### Infrastructure Layer

#### `src/infra/file/file-space-collection-repository.ts`

- Add conversion between JSON string IDs and `CollectionId` during serialization/deserialization
  - `loadCollectionsFromFile()`: Convert raw JSON `id: string` to `CollectionId` when constructing `SpaceCollection`
  - `saveCollectionsToFile()`: Convert `CollectionId` to string via `toString()` before JSON serialization
  - `addCustomCollection()`: Create `CollectionId` from generated UUID string

#### `src/infra/file/file-monitor-environment-repository.ts`

- Update serialization/deserialization for `MonitorEnvironment.lastActiveCollectionId` (`CollectionId | null` ↔ JSON string)
  - Invalid values (e.g. `preset-2-monitor`) become `null` during deserialization

### Composition Layer

#### `src/composition/controller.ts`

- `syncActiveCollectionToHistory()`: Read `CollectionId | null` from operations instead of constructing from raw string
  - Remove manual `new CollectionId(collectionIdStr)` construction
- `handleMonitorsSaveResult()`: Change parameter from `string | null` to `CollectionId | null`
  - Pass `CollectionId` to `setActiveSpaceCollectionId()` via `toString()`
  - Pass `CollectionId` directly to `setActiveCollectionId()`
- `enable()`: Convert GSettings string to `CollectionId` at the boundary
  - Use `CollectionId` constructor with try-catch for migration safety (old `preset-N-monitor` values in GSettings)

### UI Layer

#### `src/ui/main-panel/index.ts`

- Change `MainPanelOptions.getActiveSpaceCollectionId` return type from `string` to `CollectionId | null`
- Change `MainPanelOptions.getActiveSpaceCollection` parameter from `string` to `CollectionId | null`
- Update `show()` method to pass `CollectionId | null` through

### Prefs Layer

#### `src/prefs/preferences.ts`

- Convert GSettings string to `CollectionId | null` at the boundary (try-catch for invalid values)
- `onActiveChanged` callback type changes from `(string) => void` to `(CollectionId) => void`
  - Writes to GSettings via `id.toString()`

#### `src/prefs/spaces-page.ts`

- `SpacesPageState.activeCollectionId`: Change from `string` to `CollectionId | null`
- `SpacesPageState.selectedCollectionId`: Change from `string` to `CollectionId | null`
- `SpacesPageState.onActiveChanged`: Change parameter from `string` to `CollectionId`
- `SpacesPageState.checkButtons`: Map key uses `collection.id.toString()`
- `SpacesPageState.selectionIndicators`: Map key uses `collection.id.toString()`
- `createSpacesPage()`: Change `activeCollectionId` parameter from `string` to `CollectionId | null`
- `createCollectionRow()`: Access `collection.id` directly (now `CollectionId`)
  - Equality comparisons use `.equals()` instead of `===`
  - Operations methods receive `CollectionId` directly (no conversion needed)
- `createSpacesRowWidget()`, `createClickableSpace()`: Change `collectionId` parameter from `string` to `CollectionId`
- `updateSpaceEnabled()` call: Pass `CollectionId` directly

### Migration

- Old `preset-N-monitor` values stored in:
  - **GSettings** (`active-space-collection-id`): Handle in controller's `enable()` and prefs' `fillPreferencesWindow()` with try-catch — invalid values become `null`, triggering fallback to first preset
  - **monitors.json** (`lastActiveCollectionId`): Handle in deserialization — invalid values become `null`

## Sequence Diagram

```
[Startup: enable()]

GSettings ──string──> Controller
                       │
                       ├─ try CollectionId(string)
                       │   ├─ valid UUID → CollectionId
                       │   └─ invalid (preset-2-monitor) → null (fallback)
                       │
                       ▼
MonitorEnvOps.setActiveCollectionId(CollectionId)
MonitorEnvOps.detectAndSaveMonitors() ──CollectionId|null──> Controller
                       │
                       ├─ new env → null (no previous selection)
                       ├─ env switch → return stored CollectionId from MonitorEnvironment
                       └─ no change → null
                       │
                       ▼
Controller.handleMonitorsSaveResult(CollectionId|null)
  ├─ preferencesRepository.setActiveSpaceCollectionId(id.toString())
  ├─ monitorEnvOps.setActiveCollectionId(id)
  └─ layoutHistoryRepository.setActiveCollection(id)

[Panel Display: show()]

Controller ──CollectionId|null──> MainPanel.getActiveSpaceCollectionId()
MainPanel  ──CollectionId|null──> SpaceCollectionOps.getActiveSpaceCollection()
                                   ├─ non-null → findCollectionById(id)
                                   └─ null → fallback to first preset
```

## Estimate

- 8 points
